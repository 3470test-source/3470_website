<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Private Video Request Access</title>
  <link rel="stylesheet" href="styles.css" />

  <style>

    :root{
  --bg:#f7f8fb;
  --card:#fff;
  --accent:#1976d2;
  --danger:#c62828;
  --muted:#666;
}

body{
  font-family: Inter, system-ui, Arial, sans-serif;
  background:var(--bg);
  margin:0;
  padding:30px;
  color:#111;
}

.container{
  max-width:900px;
  margin:0 auto;
  background:var(--card);
  padding:24px;
  border-radius:10px;
  box-shadow:0 6px 20px rgba(20,20,50,0.06);
}

h1{ margin-top:0; }

#videoArea{
  text-align:center;
}

.hidden{ display:none; }

#errorBox{ margin-top:18px; border:1px solid #ffdede; background:#fff6f6; padding:14px; border-radius:8px; }
.error-title{ color:var(--danger); font-weight:700; margin:0 0 8px 0; }
.help-text{ color:var(--muted); margin:0 0 12px 0; }

form {
  display:flex;
  flex-direction:column;
  gap:8px;
}

label{ font-size:0.9rem; color:#333; }
input[type="email"], textarea {
  padding:10px;
  border-radius:6px;
  border:1px solid #ddd;
  font-size:1rem;
  width:100%;
  box-sizing:border-box;
}

button{
  background:var(--accent);
  color:#fff;
  border:none;
  padding:10px 12px;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}

button:disabled{ opacity:0.6; cursor:not-allowed; }

.form-message{ margin-top:6px; color:var(--muted); }
#successBox{ margin-top:18px; padding:12px; border-radius:8px; background:#f0fff6; border:1px solid #e6f6ea; }

</style>


</head>
<body>
  <main class="container">
    <h1>Course Video</h1>

    <div id="videoArea">
      <iframe
        id="ytPlayer"
        width="800"
        height="450"
        src="https://www.youtube.com/embed/RgceVDWJxjs?enablejsapi=1"
        frameborder="0"
        allowfullscreen
      ></iframe>
    </div>

    <div id="errorBox" class="hidden">
      <p class="error-title">This video is private or restricted.</p>
      <p class="help-text">
        If you should have access, submit your Gmail below and the owner will be notified.
      </p>

      <form id="requestForm">
        <label for="gmail">Your Gmail address</label>
        <input type="email" id="gmail" name="gmail" placeholder="you@example.com" required />
        <label for="note">Optional note</label>
        <textarea id="note" name="note" placeholder="e.g. I'm a paid student (optional)"></textarea>

        <button type="submit">Request Access</button>
        <div id="formMessage" class="form-message"></div>
      </form>
    </div>

    <div id="successBox" class="hidden">
      <p>Request sent. The owner has been notified via email. They'll need to add your Gmail in YouTube Studio.</p>
      <p>After they add your Gmail, refresh this page (and make sure you're signed into that Gmail on YouTube).</p>
    </div>
  </main>




  

  <script src="https://www.youtube.com/iframe_api"></script>
  
  <script>
    // Frontend JS: detects private video and sends permission request to backend

const ERROR_CODES = [150, 101];

let player;

function onYouTubeIframeAPIReady() {
  player = new YT.Player("ytPlayer", {
    events: {
      'onError': handleVideoError
    }
  });
}

function show(elementId) {
  document.getElementById(elementId).classList.remove('hidden');
}

function hide(elementId) {
  document.getElementById(elementId).classList.add('hidden');
}

function handleVideoError(event) {
  if (ERROR_CODES.includes(event.data)) {
    show('errorBox');
    // optionally hide the iframe so user sees the form
    // document.getElementById('videoArea').style.display = 'none';
  }
}

// Form handling
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('requestForm');
  const gmailInput = document.getElementById('gmail');
  const noteInput = document.getElementById('note');
  const formMessage = document.getElementById('formMessage');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    formMessage.textContent = 'Sending request...';
    form.querySelector('button').disabled = true;

    const payload = {
      gmail: gmailInput.value.trim(),
      note: noteInput.value.trim(),
      videoId: extractVideoIdFromIframe(),
      pageUrl: window.location.href,
      timestamp: new Date().toISOString()
    };

    try {
      const res = await fetch('/request-permission', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.text();
        throw new Error(err || 'Server error');
      }

      // success
      hide('errorBox');
      show('successBox');
    } catch (err) {
      console.error(err);
      formMessage.textContent = 'Failed to send request. Please try again later.';
      form.querySelector('button').disabled = false;
    }
  });
});

function extractVideoIdFromIframe(){
  try {
    const iframe = document.getElementById('ytPlayer');
    const src = iframe.getAttribute('src') || '';
    // src like https://www.youtube.com/embed/<id>?...
    const match = src.match(/embed\/([a-zA-Z0-9_-]{11})/);
    return match ? match[1] : null;
  } catch (e) {
    return null;
  }
}

  </script>
  



</body>
</html>
